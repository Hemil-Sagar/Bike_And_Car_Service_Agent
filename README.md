## Voice Service Agents

This repository contains voice-based service agents and a simple Dockerized demo app:

- `Bike_Agent/`: Twilio voice IVR for bike/car service scheduling with Google Cloud TTS and MongoDB.
- `Async_Bike_Agent/`: Async variant (work-in-progress mirror).
- `Docker/`: Minimal Flask demo app packaged for Docker (unrelated to Twilio flow; runs a multiplication table page).

### Project Structure
- `Bike_Agent/car_main.py`: Car service IVR (Hindi-first, multi-lingual) using Twilio <-> Flask.
- `Bike_Agent/main.py`: Bike service IVR entrypoint (similar to car flow).
- `Bike_Agent/google_tts.py`: Google Cloud Text-to-Speech wrapper with caching to `Bike_Agent/static/audio_cache/`.
- `Bike_Agent/mongofetch.py`: MongoDB Atlas access helpers.
- `Bike_Agent/static/audio_cache/`: Cached MP3 files generated by TTS.
- `Docker/app.py`: Standalone Flask demo (port 8000) with `Docker/Dockerfile`.

### Prerequisites
- Python 3.9+
- A Twilio account (for Voice webhooks)
- Google Cloud project with Text-to-Speech API enabled
- MongoDB Atlas cluster or any reachable MongoDB instance

### Environment Variables
Create a `.env` in `Bike_Agent/` (or export in shell):

```
# Twilio request validation (optional)
TWILIO_AUTH_TOKEN=your_twilio_auth_token
VALIDATE_REQUESTS=false

# MongoDB credentials (used in mongofetch.py; defaults shown)
MONGO_USER=Your_User
MONGO_PASSWORD=Your_Password

# Google service account for TTS (can also export in shell)
GOOGLE_APPLICATION_CREDENTIALS=/absolute/path/to/service-account-key.json
```

Notes:
- `Bike_Agent/car_main.py` also sets `GOOGLE_APPLICATION_CREDENTIALS` in code to `/home/hemil/Desktop/agent/service-account-key.json`. Prefer using the env var. Update the path or remove the hardcoded line if needed.
- If `VALIDATE_REQUESTS=true`, Twilio will be signature-validated using `TWILIO_AUTH_TOKEN`.

### Python Dependencies
Install in a virtualenv:

```
pip install -U \
  Flask twilio python-dotenv pymongo google-cloud-texttospeech \
  langchain-google-genai langchain-core python-dateutil
```

### Run Locally (Service Agent)
From the project root:

```
cd Bike_Agent
export GOOGLE_APPLICATION_CREDENTIALS=/absolute/path/to/service-account-key.json
python car_main.py
```

Default server: `http://0.0.0.0:5000`

Key endpoints (POST from Twilio Voice):
- `/voice`: greeting and call flow start
- `/car-number`: confirm vehicle number
- `/service`: confirm and offer reschedule
- `/reschedule`, `/reschedule-date`: date handling
- `/offer-services`, `/handle-services`: add-ons
- Health checks: `GET /` and `GET /health`

To run the bike-specific flow, use `python main.py` (similar endpoints and logic, bike messaging/wording).

### Twilio Configuration
1. Expose your local server (e.g., using ngrok):
   - `ngrok http 5000`
2. In Twilio Console → Phone Numbers → Your Number → Voice & Fax:
   - A Call Comes In: `Webhook` to `https://<your-ngrok-id>.ngrok.io/voice` (HTTP POST)
3. If request validation is enabled, ensure `TWILIO_AUTH_TOKEN` matches your account token.

### MongoDB
`Bike_Agent/mongofetch.py` expects a database named `car_service_db` with collections:
- `users` documents keyed by `phone_number` and containing `car_number`
- `car_services` documents keyed by `car_number`, with fields like `next_service_date` and `selected_services`

Update credentials via `MONGO_USER`/`MONGO_PASSWORD`, or modify the URI in `mongofetch.py` to match your cluster.

### Audio Cache
Generated audio is stored under `Bike_Agent/static/audio_cache/`. The server ensures this folder exists on startup. You can clear cache via helper methods in `google_tts.py`.

### Docker Demo App (optional)
This is a separate demo not tied to Twilio:

```
cd Docker
docker build -t demo .
docker run -p 8000:8000 demo
```

Visit `http://localhost:8000` for the multiplication table page.

### Troubleshooting
- Invalid Twilio signature → set `VALIDATE_REQUESTS=false` for local, or ensure correct public URL and token.
- TTS errors → verify `GOOGLE_APPLICATION_CREDENTIALS` path and that the TTS API is enabled.
- Mongo errors → confirm IP allowlist/credentials in MongoDB Atlas and update `MONGO_*` env vars.


